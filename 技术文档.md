多模态医疗问答系统技术文档

一、系统概述
- 本系统是一个围绕医疗场景的多模态 RAG（检索增强生成）问答平台，支持 PDF 医疗文档解析、索引构建与检索、流式回答（SSE）、知识图谱增强与医疗关联扩展、基础安全审查与意图识别。
- 前端提供交互式问答与可视化；后端提供 REST/SSE 接口以及文档处理、索引、知识图谱与关联服务。

二、架构组成
- 前端：Vite + React/TypeScript，提供聊天界面、PDF 文件上传与解析进度、引用（citation）展示、与后端 SSE 通道对接。<mcfile name="frontend" path="/Users/jinlingxiao/Downloads/RAGAgent/frontend"></mcfile>
- 后端：FastAPI 提供 REST 与 SSE 接口，服务模块化拆分。
  - 核心应用入口：<mcfile name="app.py" path="/Users/jinlingxiao/Downloads/RAGAgent/backend/app.py"></mcfile>
  - 增强 RAG 服务：<mcfile name="enhanced_rag_service.py" path="/Users/jinlingxiao/Downloads/RAGAgent/backend/services/enhanced_rag_service.py"></mcfile>
  - 医疗知识图谱：<mcfile name="medical_knowledge_graph.py" path="/Users/jinlingxiao/Downloads/RAGAgent/backend/services/medical_knowledge_graph.py"></mcfile>
  - 医疗关联服务：<mcfile name="medical_association_service.py" path="/Users/jinlingxiao/Downloads/RAGAgent/backend/services/medical_association_service.py"></mcfile>
  - 医疗索引与检索：<mcfile name="enhanced_index_service.py" path="/Users/jinlingxiao/Downloads/RAGAgent/backend/services/enhanced_index_service.py"></mcfile>
  - PDF 解析与页面输出：<mcfile name="pdf_service.py" path="/Users/jinlingxiao/Downloads/RAGAgent/backend/services/pdf_service.py"></mcfile>
  - 安全审查与意图识别：<mcfile name="medical_safety_service.py" path="/Users/jinlingxiao/Downloads/RAGAgent/backend/services/medical_safety_service.py"></mcfile> <mcfile name="smart_intent_service.py" path="/Users/jinlingxiao/Downloads/RAGAgent/backend/services/smart_intent_service.py"></mcfile> <mcfile name="qwen_intent_service.py" path="/Users/jinlingxiao/Downloads/RAGAgent/backend/services/qwen_intent_service.py"></mcfile>

三、核心数据流（高层）
- 用户在前端输入问题 → 前端通过 SSE 请求后端 Chat 接口 → 后端在检索阶段使用知识图谱增强与医疗关联扩展构造增强查询 → 使用医疗索引进行检索，生成 citations 与上下文 → 后端对回答进行（可选）安全审查与意图识别 → 通过 SSE 按 token 流、citation、done 等事件推送到前端。

四、后端接口列表（主要）
- 健康检查：GET /api/v1/health（运行状态与版本）
- 通用 Chat（SSE）：POST /api/v1/chat
  - 事件类型：token、citation、done、error（详见“流式事件协议”）
- 通用 Chat 清理：POST /api/v1/chat/clear
- PDF 管线：
  - 上传：POST /api/v1/pdf/upload
  - 触发解析：POST /api/v1/pdf/parse
  - 状态查询：GET /api/v1/pdf/status
  - 页面图访问：GET /api/v1/pdf/page
  - 页面图片访问：GET /api/v1/pdf/images
  - 片段查询（引用内容）：GET /api/v1/pdf/chunk
- 向量索引：
  - 构建：POST /api/v1/index/build
  - 检索：POST /api/v1/index/search
- 医疗索引与检索：
  - 构建：POST /api/v1/medical/index/build
  - 检索（文本）：POST /api/v1/medical/search
  - 症状检索：POST /api/v1/medical/search/symptoms
  - 药物相互作用检索：POST /api/v1/medical/search/drug
  - 统计与枚举：GET /api/v1/medical/statistics、GET /api/v1/medical/departments、GET /api/v1/medical/document-types、GET /api/v1/medical/disease-categories
  - 删除索引：POST /api/v1/medical/index/delete
  - 优化索引：POST /api/v1/medical/index/optimize
- 医疗 RAG：
  - 医疗 Chat（SSE）：POST /api/v1/medical/chat（支持安全审查与意图识别策略）
  - 清理：POST /api/v1/medical/chat/clear
  - 症状分析：POST /api/v1/medical/analyze/symptoms
  - 药物相互作用分析：POST /api/v1/medical/analyze/drug-interactions
  - 历史：GET /api/v1/medical/chat/history
  - 安全审查统计：GET /api/v1/medical/safety/review-stats
- 医疗关联服务：
  - 关联搜索：POST /api/v1/medical/associations/search
  - 增强症状分析：POST /api/v1/medical/analyze/symptoms-enhanced
  - 增强药物分析：POST /api/v1/medical/analyze/drug-interactions-enhanced
  - 关联统计：GET /api/v1/medical/associations/statistics
  - 从文档更新：POST /api/v1/medical/associations/update
- 知识图谱（KG）：
  - 实体关系搜索：POST /api/v1/knowledge-graph/entity/search
  - 统计：GET /api/v1/knowledge-graph/statistics
  - 更新：POST /api/v1/knowledge-graph/update
  - 查询增强：POST /api/v1/knowledge-graph/enhance-query

五、流式事件协议（SSE）
- 事件类型：
  - token：逐字/逐句流式文本；data 形如 {"text":"..."}
  - citation：命中引用的元数据块；data 为 JSON，包含 citation_id、文件页信息与片段等
  - done：结束事件；data 含 {"used_retrieval": true|false}
  - error：错误事件；data 含 {"message":"..."}
- 参考定义与实现：<mcfile name="app.py" path="/Users/jinlingxiao/Downloads/RAGAgent/backend/app.py"></mcfile>（通用 Chat 与医疗 Chat SSE 段落）。

六、知识图谱模块（KG）
- 存储路径：backend/data/medical_knowledge_graph.pkl（Pickle 持久化）。
- 结构：使用 networkx.MultiDiGraph 保存节点与边；并维护实体字典、名称与类型索引。
- 加载与初始化：
  - 若存在持久化文件则加载；否则初始化基础实体与关系并保存。
- 主要服务方法：
  - KG 服务类：<mcsymbol name="MedicalKnowledgeGraphService" filename="medical_knowledge_graph.py" path="/Users/jinlingxiao/Downloads/RAGAgent/backend/services/medical_knowledge_graph.py" startline="494" type="class"></mcsymbol>
  - 查询增强：<mcsymbol name="enhance_query_with_kg" filename="medical_knowledge_graph.py" path="/Users/jinlingxiao/Downloads/RAGAgent/backend/services/medical_knowledge_graph.py" startline="500" type="function"></mcsymbol>
  - 实体关系查询：<mcsymbol name="find_entity_relationships" filename="medical_knowledge_graph.py" path="/Users/jinlingxiao/Downloads/RAGAgent/backend/services/medical_knowledge_graph.py" startline="544" type="function"></mcsymbol>
  - 统计：<mcsymbol name="get_knowledge_graph_stats" filename="medical_knowledge_graph.py" path="/Users/jinlingxiao/Downloads/RAGAgent/backend/services/medical_knowledge_graph.py" startline="578" type="function"></mcsymbol>
  - 文档更新：<mcsymbol name="update_kg_from_documents" filename="medical_knowledge_graph.py" path="/Users/jinlingxiao/Downloads/RAGAgent/backend/services/medical_knowledge_graph.py" startline="582" type="function"></mcsymbol>

七、医疗关联模块
- 基于关键字、同义词与规则的关联扩展，为检索阶段提供补充术语（例如“头痛 咳嗽 发热”等常见组合）。
- 接口详见“医疗关联服务”分组，便于统计、搜索与从文档更新。

八、增强 RAG 服务
- 结合 KG 与医疗关联，对用户原始查询进行扩展，控制扩展数量（如取 Top-N）并拼接到检索 query 中，用于提升检索召回与相关性。
- 相关外观接口（对 app 暴露）：
  - 历史：<mcsymbol name="get_history" filename="enhanced_rag_service.py" path="/Users/jinlingxiao/Downloads/RAGAgent/backend/services/enhanced_rag_service.py" startline="641" type="function"></mcsymbol>
  - 追加历史：<mcsymbol name="append_history" filename="enhanced_rag_service.py" path="/Users/jinlingxiao/Downloads/RAGAgent/backend/services/enhanced_rag_service.py" startline="644" type="function"></mcsymbol>
  - 清理历史：<mcsymbol name="clear_history" filename="enhanced_rag_service.py" path="/Users/jinlingxiao/Downloads/RAGAgent/backend/services/enhanced_rag_service.py" startline="647" type="function"></mcsymbol>
  - 医疗检索：<mcsymbol name="medical_retrieve" filename="enhanced_rag_service.py" path="/Users/jinlingxiao/Downloads/RAGAgent/backend/services/enhanced_rag_service.py" startline="650" type="function"></mcsymbol>
  - 医疗回答流：<mcsymbol name="medical_answer_stream" filename="enhanced_rag_service.py" path="/Users/jinlingxiao/Downloads/RAGAgent/backend/services/enhanced_rag_service.py" startline="682" type="function"></mcsymbol>

九、PDF 解析模块
- 支持 PDF 上传与后台解析（页图输出与 Markdown 文本抽取），并维护解析进度。
- 关键目录：原始 PDF、解析页输出、Markdown 输出等由 <mcsymbol name="pdf_service" filename="pdf_service.py" path="/Users/jinlingxiao/Downloads/RAGAgent/backend/services/pdf_service.py" startline="1" type="function"></mcsymbol> 管理（查看文件以了解路径约定）。

十、环境与依赖
- 关键环境变量：
  - HF_ENDPOINT、HUGGINGFACE_HUB_CACHE、TRANSFORMERS_CACHE、TIMM_CACHE_DIR（镜像与缓存）
  - DASHSCOPE_API_KEY（同义千问/嵌入等）
- Python 依赖：FastAPI、uvicorn、pydantic、networkx、dotenv、langchain 生态可选项等；实际清单见 <mcfile name="requirements.txt" path="/Users/jinlingxiao/Downloads/RAGAgent/backend/requirements.txt"></mcfile>

十一、运行与部署
- 后端本地开发：
  - 建议使用虚拟环境并按 requirements.txt 安装依赖。
  - 运行：uvicorn app:app --host 0.0.0.0 --port 8001 --reload
- 前端本地开发：
  - 在 frontend 目录安装依赖并运行开发服务器（npm install && npm run dev）。
- 访问地址：
  - 后端：http://localhost:8001/
  - 前端：http://localhost:3001/（如 3000 端口占用则自动切换）

十二、配置项与参数
- 医疗 Chat 请求体（主要字段）：
  - message：用户问题
  - sessionId：会话 ID
  - department、documentType、diseaseCategory：限定检索范围的分类枚举
  - enableSafetyCheck：是否进行安全审查
  - intentRecognitionMethod：意图识别策略（smart、qwen、keyword）

十三、安全与合规
- 基础的内容安全审查：过滤极端或高风险医疗建议；必要时提示就医与免责声明。
- 提醒：系统输出仅供参考，非替代医生诊断与专业建议。

十四、典型交互流程
- 用户上传 PDF → 触发解析并跟踪进度 → 构建医疗索引 → 提问（医疗 Chat）→ 后端进行 KG 增强与关联扩展 → 检索命中文档、生成 citations → SSE 推送回答与引用 → 用户查看详情（如片段内容与所在页）。

十五、扩展建议
- 丰富 medical_dict.txt 同义词与别名，提高实体识别召回。
- 增补 medical_knowledge_graph.pkl 的疾病、症状、药物节点与关系，覆盖常见问题（如“感冒”）的查询增强。
- 结合模型意图识别与规则策略，针对泛化问题引导用户提供更具体信息，提高检索精准度。



这是一个直接调用后端 FastAPI 医疗问答（SSE 流式）的命令示例，你可以在本机终端执行：
curl -N -H "Accept: text/event-stream" -H "Content-Type: application/json" -d 
'{"message":"请解释空腹血糖偏高的风险与建议","sessionId":"medical_default","enableSafetyCheck":true,"intentRecognitionMethod":"smart"}' http://localhost:8001/api/v1/medical/chat说明：-N 让 curl 不进行缓冲，便于实时接收 SSE 流式事件Accept 指定为 text/event-stream 以接收服务端的流式事件message 为你的问题，sessionId 用于绑定会话上下文（记忆管理）enableSafetyCheck 可开启医疗安全审核，intentRecognitionMethod 用于自动识别意图与检索策略该端点由后端函数提供：medical_chat_stream