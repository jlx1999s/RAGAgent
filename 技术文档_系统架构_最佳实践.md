# 多模态医疗RAG系统技术架构（后端实现说明）

本文档仅描述当前仓库的后端服务实现，按医生端与患者端分别说明入口、流程、模块职责与文件位置。

## 文档范围
- 后端实现与模块说明（FastAPI、服务层、向量库、知识图谱、意图与安全）。
- 医生端：`backend/`。
- 患者端：`backend/patient/`。

---

## 医生端（backend/）

- 入口与路由
  - `backend/app.py`：FastAPI 应用与路由注册。启动入口为 `uvicorn.run(app, host="0.0.0.0", port=8000)`。

- 服务流程
  - 请求接收：文本查询（可包含元数据如科室）。
  - 意图识别：`medical_intent_service.py`、`smart_intent_service.py`、`qwen_intent_service.py`。
  - 安全策略：`medical_safety_service.py`。
  - 检索与融合：`enhanced_rag_service.py` 与 `medical_vector_store.py`、`medical_knowledge_graph.py`、`medical_taxonomy.py`。
  - 生成与引用：`rag_service.py`。

- 模块职责（文件映射）
  - `medical_vector_store.py`：向量库封装（索引、插入、检索）。
  - `medical_preprocessor.py`：文本清洗与分块、元数据抽取。
  - `enhanced_index_service.py`：文档索引与嵌入。
  - `enhanced_rag_service.py`：检索与结果重排、知识图谱融合。
  - `rag_service.py`：回答生成与证据聚合。
  - `medical_knowledge_graph.py`、`medical_taxonomy.py`：知识图谱与术语体系。
  - `cache_service.py`、`state_store.py`：缓存与状态存储。
  - 其它辅助模块：`query_quality_assessor.py`、`medical_association_service.py` 等。

- 接口
  - 具体路径与入参/出参以 `backend/openapi.yaml` 为准。

---

## 患者端（backend/patient/）

- 入口与路由
  - `backend/patient/app.py`：FastAPI 应用与路由注册。
  - 接口定义：`backend/patient/openapi.yaml`。

- 服务流程
  - 会话与请求：前端发送 `session_id` 与查询，体检报告通过 POST 附件方式上传（上传流程由前端处理）。
  - 报告解析：`backend/services/pdf_service.py`。
  - 文本预处理与分块：`backend/services/medical_preprocessor.py`。
  - 会话级索引与嵌入：`backend/patient/services/enhanced_index_service.py` 将体检报告嵌入并写入向量库的会话集合（`session_context`）。
  - 检索与生成：`backend/patient/services/enhanced_rag_service.py` 与 `backend/services/rag_service.py`，合并共享知识库与会话上下文进行检索与生成。

- 模块职责（文件映射）
  - `backend/patient/services/enhanced_index_service.py`：体检报告索引与会话级上下文写入。
  - `backend/patient/services/enhanced_rag_service.py`：患者端检索与融合。
  - `backend/services/medical_vector_store.py`：向量库集合，包括 `global_kb` 与 `session_context`。
  - `backend/services/state_store.py`、`backend/services/cache_service.py`：会话状态与缓存。
  - 测试与验证：`backend/patient/test_*`、`backend/patient/tests/` 等。

---

## 知识库与检索（当前实现）

- 向量库与索引
  - `medical_vector_store.py` 提供存储与检索接口。
  - 实现包含 FAISS 封装；索引结构与参数在模块内按配置使用（如 HNSW、IVF-PQ）。

- 文档处理
  - PDF 解析：`pdf_service.py`。
  - 预处理与分块：`medical_preprocessor.py`。

- 检索与融合
  - 检索与重排在 `enhanced_rag_service.py` 实现。
  - 知识图谱相关处理在 `medical_knowledge_graph.py`、术语与分类在 `medical_taxonomy.py`。

---

## 运维、运行与测试

- 运行脚本
  - 通用：`start_integrated_services.sh`、`stop_integrated_services.sh`。
---

## 文件索引与位置（摘要）
- 入口：`backend/app.py`、`backend/patient/app.py`。
- 接口定义：`backend/openapi.yaml`、`backend/patient/openapi.yaml`。
- 检索与生成：`backend/services/enhanced_rag_service.py`、`backend/services/rag_service.py`、`backend/patient/services/enhanced_rag_service.py`。
- 索引与嵌入：`backend/services/enhanced_index_service.py`、`backend/patient/services/enhanced_index_service.py`。
- 文档解析与预处理：`backend/services/pdf_service.py`、`backend/services/medical_preprocessor.py`。
- 向量库：`backend/services/medical_vector_store.py`。
- 知识图谱与术语：`backend/services/medical_knowledge_graph.py`、`backend/services/medical_taxonomy.py`。
- 会话与缓存：`backend/services/state_store.py`、`backend/services/cache_service.py`。
- 运行与生产：`start_*.sh`、`scripts/start-patient.sh`、`production_*`。
- 测试：`backend/test_*`、`backend/patient/test_*`、`tests/`。